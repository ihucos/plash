#!/usr/bin/env python3


import subprocess
from sys import argv
import os
from tempfile import mkdtemp


BASE_DIR = os.environ['PLASH_DATA']
MNT_DIR = os.path.join(BASE_DIR, 'mnt')

squashdir = mkdtemp(dir=MNT_DIR, suffix='.{}'.format(os.getpid()))

p = subprocess.Popen(['mount', argv[1], squashdir])
assert not p.wait()

cmd = ['plash', 'chroot', squashdir, '--', '/entrypoint'] + argv[2:]
os.execvpe(cmd[0], cmd, os.environ)
