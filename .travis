#!/usr/bin/env plash-exec
# plash-exec: exec=/entrypoint
--image
ubuntu
--apt
python3-setuptools
python3-pip
python3-coverage
python3-jinja2
git
twine
--pip3
codecov
--layer
--write-script
/entrypoint
#!/bin/sh
set -eux

if test ${TRAVIS_BRANCH:-} = master; then
  deploy=yes
else
  deploy=no
fi

test -n "${TRAVIS:-}" && sed -i -e "s/VERSION = '0.1dev'/VERSION = "0.$TRAVIS_BUILD_NUMBER"/g" setup.py
python3 setup.py --quiet develop

for f in /usr/lib/python3.*; do
  cp ./misc/sitecustomize_for_codecoverage/sitecustomize.py $f
done

# setup COVERAGE_PROCESS_START env
covtmp=$(mktemp -d)
cp .coveragerc $covtmp
echo "data_file=${PWD}/.coverage" >> $covtmp/.coveragerc
export COVERAGE_PROCESS_START=$covtmp/.coveragerc

python3 -m coverage erase
cd /
plash init
plash test
cd - 2> /dev/null

rm /usr/lib/python3.*/sitecustomize.py

python3 -m coverage combine
python3 -m coverage xml
python3 -m coverage report
codecov

misc/mkdocs
python3 -m coverage html --directory ./docs/htmlcov 

git add docs
git add -f docs/htmlcov
git commit -m 'deploy docs [skip ci]' --allow-empty
test "$deploy" = yes && git push https://${GH_TOKEN}@github.com/ihucos/plash-docs-deploy.git HEAD:master --force
git reset --soft HEAD^ # undo da commit

# upload to pypi. maybe in a better future we
# don't need the autogenerated config anymore
python3 setup.py --quiet bdist_wheel
tmp=$(mktemp)
echo '[distutils]' >> $tmp
echo 'index-servers=pypi' >> $tmp
echo '[pypi]' >> $tmp
echo 'repository=https://pypi.org/legacy/' >> $tmp

if test "$deploy" = yes; then
  twine upload --config-file $tmp -r pypi -u $PYPI_USER -p $PYPI_PASSWORD dist/*
  git tag "0.$TRAVIS_BUILD_NUMBER" -m "https://pypi.org/project/plash/0.$TRAVIS_BUILD_NUMBER"
  git push https://${GH_TOKEN}@github.com/ihucos/plash.git --tags
fi
