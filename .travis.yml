language: generic

install:
- sudo apt-get install uidmap unionfs-fuse
- curl -lF https://github.com/ihucos/build-fuse-overlayfs/releases/download/03-04-2019/fuse-overlayfs > /usr/local/bin/fuse-overlayfs
- chmod +x /usr/local/bin/fuse-overlayfs

script:

  # test that only /opt and /usr are affected by an installation
  - >
    test "$(curl -Lf https://github.com/ihucos/plash/archive/"$TRAVIS_COMMIT".tar.gz
    | tar -z --list | cut -d/ -f2 | sort | uniq)"
    = "$(printf "\nopt\nusr")"

  # install plash for this commit
  - curl -Lf https://github.com/ihucos/plash/archive/"$TRAVIS_COMMIT".tar.gz | sudo tar -xzC / --strip-components=1

  # test version number expansion
  - |-
    [[ "${TRAVIS_COMMIT}" = "$(plash version)"* ]]

  # test as root with overlay
  - sudo PLASH_INIT_UNION_TASTE=overlay plash test

  # test fuse-overlayfs
  - PLASH_INIT_UNION_TASTE=fuse-overlayfs plash test

  # test unionfs-fuse
  - PLASH_INIT_UNION_TASTE=unionfs-fuse plash test
