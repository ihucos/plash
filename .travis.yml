language: python
sudo: enabled
python:
  - "3.5"
  - "3.6"
  - "pypy3.5"

install:
  - pip --version
  - pip install setuptools

script:
  - sudo misc/runtests
  - sed -i -e "s/VERSION = '0.1dev'/VERSION = '0.$TRAVIS_BUILD_NUMBER'/g" setup.py
  - python --version
  - sudo python setup.py install
  - sudo plash-init
  - sudo misc/pretty
  - git checkout prettyfy-test
  - git commit -am "automatic prettify"
  - git push https://${GH_TOKEN}@github.com/ihucos/plash.git

deploy:
  - provider: script
    script:
      - sudo misc/pretty
      - git commit -am "prettify test"
      - git push https://${GH_TOKEN}@github.com/ihucos/plash.git
    on:
      condition: $TRAVIS_PYTHON_VERSION = 3.5
  - provider: pypi
    user: $PYPI_USER
    password: $PYPI_PASSWORD
    distributions: "sdist"
    skip_cleanup: true
    on:
      branch: master
      condition: $TRAVIS_PYTHON_VERSION = 3.6
  - provider: script
    script: git tag 0.$TRAVIS_BUILD_NUMBER -m "https://pypi.org/project/plash/0.$TRAVIS_BUILD_NUMBER" && git push https://${GH_TOKEN}@github.com/ihucos/plash.git --tags
    on:
      branch: master
      condition: $TRAVIS_PYTHON_VERSION = 3.6
