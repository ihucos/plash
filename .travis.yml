language: generic
sudo: enabled

install:
  # install plash
  - sudo apt-get install python3 python3-pip
  - sudo pip3 install plash

cache:
  directories:
    - ~/plashcache

git:
  depth: 1

env:
  - BUILD="--alpine python3 bash"
  - BUILD="--ubuntu python3"

  # wait for: https://bitbucket.org/pypy/pypy/issues/2759/osmakedirs-behaviour-differs-from-cpython
  # - BUILD="--fedora pypy3 --run 'ln -fs /usr/bin/pypy3 /usr/bin/python3'"

script:

  # load cache
  - sudo tar -xvf ~/plashcache/data.tar -C /
  - sudo plash-init

  - IFS=$'\n' arr=( $(xargs -n1 <<<"$BUILD") )
  - sudo plash-build ${arr[@]}
  - sudo plash-run ${arr[@]} --layer --devinit -- sh -c 'ln -s $(mktemp -d)/plashdata /var/lib/plash && misc/runtests'

  # save cache
  - sudo tar -cf ~/plashcache/data.tar /var/lib/plash/

