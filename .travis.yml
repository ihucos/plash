language: generic

install:
- sudo apt-get install uidmap unionfs-fuse musl-tools

script:

  # check that all binaries are up to date
  - (cd opt/plash && make --question)

  - git status -s

  - make

  - git status -s

  # test that only /opt and /usr are affected by an installation
  - >
    test "$(curl -Lf https://github.com/ihucos/plash/archive/"$TRAVIS_COMMIT".tar.gz
    | tar -z --list | cut -d/ -f2 | sort | uniq)"
    = "$(printf "\nopt\nusr")"

  # install plash for this commit
  - curl -Lf https://github.com/ihucos/plash/archive/"$TRAVIS_COMMIT".tar.gz | sudo tar -xzC / --strip-components=1

  # test version number expansion
  - test "$(plash version)" = "${TRAVIS_COMMIT:0:7}"

  # test as root with overlay
  - sudo PLASH_INIT_UNION_TASTE=overlay plash test

  # test user mode
  - plash test
