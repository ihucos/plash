#!/usr/bin/env python3

# usage: plash-nodepath CONTAINER
# Prints the location of the last layer of a container.
# Example: `plash-nodepath mycontainer | xargs tree`


import os
import sys
from json import dumps

from plashlib.utils import die, handle_help_flag, die_with_usage, catch_and_die

PLASH_DATA = os.environ.get('PLASH_DATA', '/var/lib/plash')

handle_help_flag()

try:
    container = sys.argv[1]
except IndexError:
    die_with_usage()

try:
    # security check that container does not contain bad chars
    with catch_and_die([OSError], ignore=FileNotFoundError, debug='readlink'):
        link = os.readlink(os.path.join(PLASH_DATA, 'links', container))
    with catch_and_die([OSError], ignore=FileNotFoundError, debug='stat'):
        os.stat(link)
except FileNotFoundError:
    die('No container {}'.format(dumps(container)), exit=3)
print(link)
