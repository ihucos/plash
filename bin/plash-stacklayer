#!/usr/bin/env python3
#
# usage: plash-stacklayer PARENT-CONTAINER NEW-LAYER-ID IMPORT-DIR
# return a new container id


from tempfile import mkdtemp
import os
import sys
from plashlib.utils import catch_and_die, color, die, hashstr, info, nodepath_or_die, die_with_usage, handle_help_flag, handle_build_args
from os.path import join


PLASH_DATA = os.environ.get('PLASH_DATA', '/var/lib/plash')

handle_help_flag()
handle_build_args()

try:
    container, new_layer_id, new_layer_payload = sys.argv[1:4]
except ValueError:
    die_with_usage()

if container == 'root': # that container is special
    node_new_dst = join(PLASH_DATA, 'builds', new_layer_id)
else:
    nodepath = nodepath_or_die(container)
    node_new_dst = join(nodepath, 'children', new_layer_id)


#
# create a short id for the layer in the 'links' folder.
# put a link there pointing to node_new_dst before copying anything there so we don't 'loose'
# orphaned data there. Cleaning broken symlinks in links is easier than traversing the build folder.
# that the links are short (~ 3 charachters) is a covenience.
#
#for i in range(2, len(new_layer_id)):
#    short = (new_layer_id[:i + 1])
#    linkname = join(PLASH_DATA, 'links', short)
#    try:
#        with catch_and_die([OSError], ignore=FileExistsError, debug='symlink'):
#            os.symlink(node_new_dst, linkname)
#    except FileExistsError:
#        if os.readlink(
#                linkname
#        ) == node_new_dst and os.path.exists(node_new_dst):
#
#            # already cached
#            print(short)
#            sys.exit(3)
#    else:
#        break

try:
    os.symlink(node_new_dst, join(PLASH_DATA, 'links', new_layer_id))
except FileExistsError:
    die('that layer id already exists')

new_node = mkdtemp(dir=join(PLASH_DATA, 'tmp'))
os.mkdir(join(new_node, 'payload'))
os.mkdir(join(new_node, 'children'))
os.rename(new_layer_payload, join(new_node, 'payload'))

try:
    os.rename(new_node, node_new_dst)
except OSError as exc:
    if exc.errno == errno.ENOTEMPTY:
        info('container id or layer appeared while building, not replacing it'.
             format(new_layer_id))
    else:
        raise
