#!/usr/bin/env python3
#
# usage: plash-runp CONTAINER [ARG1 [ARG2 [ARG3...]]
# Run a container with runp.
# See the runp project page: https://github.com/ihucos/runp

import sys
from shutil import which
from os import mkdir, execlp, symlink
from plashlib.utils import die_with_usage, handle_help_flag, die, handle_build_args
from plashlib import ux

handle_help_flag()
handle_build_args()
ux.assert_initialized()
ux.assert_is_root()

try:
    container, *cmd = sys.argv[1:]
except ValueError:
    die_with_usage()
ux.assert_container_exists(container)

runp_binary = which('runp')
if not runp_binary:
    die('Could not find runp in PATH, `plash runp` needs the runp binary to run commands'
        )

mount_wrapper = mkdtemp(join(PLASH_DATA, 'tmp'))
prog_dir = join(mount_wrapper, 'prog.dir')
prog = join(mount_wrapper, 'prog')

mkdir(prog_dir)
check_call(['plash-mount', container, prog_dir])
symlink(runp_binary, prog)
execlp(prog, prog, sys.argv[1:])
