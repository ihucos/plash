#!/bin/sh

# usage: plash runp CONTAINER [ARG1 [ARG2 [ARG3...]]
# Run a container with runp.
# See the runp project page: https://github.com/ihucos/runp

set -eu

plash_data="${PLASH_DATA:-/var/lib/plash}"

test "$*" = --help && exec plash-help "$0"
test $# -eq 0 && {
  plash-help --usage "$0"
  exit 2
}

runp_binary=$(command -v runp 2>/dev/null) || {
  echo 'Could not find runp in PATH, `plash runp` needs the runp binary to run commands' >&2
  exit 1
}

container="$1"
mount_wrapper=$(mktemp -d $plash_data/tmp/XXXXXXXXXXXX)
mkdir $mount_wrapper/prog.dir
plash-mount $container $mount_wrapper/prog.dir
ln -s $runp_binary $mount_wrapper/prog
shift
exec $mount_wrapper/prog "$@"
