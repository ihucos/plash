#!/usr/bin/env python3
# vim: set filetype=python:
import os
import re
import sys
from urllib.error import URLError
from urllib.request import urlopen

from plashlib.utils import die, catch_and_die

LXC_URL_TEMPL = 'https://images.linuxcontainers.org/images/{}/{}/{}/{}/{}/rootfs.tar.xz'

try:
    image_name = sys.argv[1]
except IndexError:
    sys.stderr.write('USAGE: plash import-linuxcontainers IMAGE-NAME\n')
    sys.exit(2)

with catch_and_die([URLError]):
    content = urlopen(
        'https://images.linuxcontainers.org/').read().decode()
matches = re.findall(
    '<tr><td>(.+?)</td><td>(.+?)</td><td>(.+?)</td><td>(.+?)</td><td>(.+?)</td><td>(.+?)</td><td>(.+?)</td><td>(.+?)</td></tr>',
    content)

names = {}
for distro, version, arch, variant, date, _, _, _ in matches:
    if not variant == 'default':
        continue

    if arch != 'amd64':  # only support this right now
        continue

    url = LXC_URL_TEMPL.format(distro, version, arch, variant, date)

    if version == 'current':
        names[distro] = url

    elif version[0].isalpha():
        # path parts with older upload_version also come later
        # (ignore possibel alphanumeric sort for dates on this right now)
        names[version] = url
    else:
        names['{}{}'.format(distro, version)] = url

try:
    url = names[image_name]
except KeyError:
    die('Image not found: {}'.format(repr(image_name)))
cmd = ['plash.import-url', url, image_name]
os.execvpe(cmd[0], cmd, os.environ)
